# rustydb.toml - Canonical Instance Configuration (v0.3.1)
# Instance Layout Spec v1.0
#
# This file is intended to be stable, human-managed, and suitable for automation.
# Layering (recommended):
#   - conf/rustydb.toml (base)
#   - conf/overrides.d/*.toml (lexicographic overrides)
#   - CLI flags / env vars (highest precedence)
#
# All relative paths are resolved against --home (INSTANCE_ROOT).

# =============================================================================
# Instance Configuration
# =============================================================================
[instance]
# Logical instance name; should match directory name when using --instance.
name = "default"

# Optional: stable identifier for telemetry/logging correlation.
# If omitted, server may read from data/meta/instance-id or generate one.
# instance_id = "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"

# Human-readable description; not used for logic.
description = ""

# =============================================================================
# Path Configuration
# =============================================================================
[paths]
# In v1.0 layout, paths default relative to --home (INSTANCE_ROOT).
# You may override with absolute paths, but best practice is to keep them instance-local.

# Configuration directory
conf_dir = "conf"

# Data directory (persistent storage)
data_dir = "data"

# Log files directory
logs_dir = "logs"

# Runtime directory (PID files, sockets)
run_dir = "run"

# Cache directory (disposable, recreatable)
cache_dir = "cache"

# Temporary files directory
tmp_dir = "tmp"

# Backup storage directory
backup_dir = "backup"

# Diagnostics directory (debug bundles, core dumps)
diag_dir = "diag"

# =============================================================================
# Server Configuration
# =============================================================================
[server]
# Bind addresses; use explicit values for enterprise predictability.
# Recommended: bind only localhost by default; allow 0.0.0.0 explicitly for production.
listen_host = "127.0.0.1"
listen_port = 54321

# Optional admin/metrics endpoints (separate from main server)
# admin_listen_host = "127.0.0.1"
# admin_listen_port = 54322

# Connection limits and timeouts
max_connections = 500
idle_timeout_ms = 300000
request_timeout_ms = 30000

# Maximum query execution time (0 = unlimited)
query_timeout_ms = 0

# Connection backlog for accept queue
backlog = 1024

# =============================================================================
# IPC Configuration (Unix Domain Sockets / Windows Named Pipes)
# =============================================================================
[server.ipc]
enabled = true

# Relative to run_dir; OS-specific behavior in implementation.
# Linux: directory for Unix domain sockets
# Windows: named-pipes namespace mapping
path = "sockets"

# Optional socket/pipe name (defaults to "rustydb")
# name = "rustydb"

# =============================================================================
# Security Configuration
# =============================================================================
[security]
# Run mode guidance (affects default behaviors)
#   "dev"  = permissive defaults, local-only, verbose logging, no TLS required
#   "prod" = safer defaults, stricter validation, TLS recommended
mode = "dev"

# =============================================================================
# TLS Configuration
# =============================================================================
[tls]
enabled = false

# Certificate paths relative to conf_dir (recommended); can also be absolute.
cert_path = "secrets/tls/server.crt"
key_path = "secrets/tls/server.key"

# Optional CA certificate for client verification
# ca_path = "secrets/tls/ca.crt"

# Require client certificates (mutual TLS)
# require_client_cert = false

# Minimum TLS version: "1.2" or "1.3"
min_version = "1.2"

# =============================================================================
# Authentication Configuration
# =============================================================================
[auth]
# Authentication modes:
#   "none"     - No authentication (dev only, not recommended for production)
#   "password" - Username/password authentication
#   "mtls"     - Mutual TLS client certificate authentication
#   "token"    - Token-based authentication (JWT, API keys)
#   "ldap"     - LDAP/Active Directory authentication
#   "kerberos" - Kerberos authentication
mode = "none"

# If using file-based auth, keep it under conf/secrets/auth and treat as sensitive.
# users_path = "secrets/auth/users.json"

# Session timeout in milliseconds (default: 30 minutes)
session_timeout_ms = 1800000

# Maximum failed login attempts before lockout
max_failed_attempts = 5

# Lockout duration in milliseconds
lockout_duration_ms = 300000

# =============================================================================
# Logging Configuration
# =============================================================================
[logging]
# Logging modes:
#   "file"   => write to logs_dir
#   "stdout" => emit structured logs to stdout/stderr (recommended for containers)
mode = "file"

# Log format:
#   "json" - recommended for enterprise ingestion and log aggregation
#   "text" - human-readable for developer readability
format = "json"

# Log level: trace, debug, info, warn, error
level = "info"

# Enable separate audit channel for security events
audit_enabled = false

# Log rotation policy (if using internal rotation)
# Otherwise rely on external logrotate (Linux) or Windows tooling
rotate = true
max_files = 10
max_file_size_mb = 100

# Include timestamps in all log entries
include_timestamps = true

# Include source location (file:line) in debug logs
include_source_location = false

# =============================================================================
# Storage Configuration
# =============================================================================
[storage]
# Data durability settings
fsync = true
sync_interval_ms = 1000

# Page size in bytes (must be power of 2, typically 4096 or 8192)
page_size = 4096

# Buffer pool size in pages
buffer_pool_pages = 1000

# Optional: compression algorithm for data pages
# compression = "zstd"

# Optional: encryption-at-rest settings
# encryption_enabled = false

# =============================================================================
# Write-Ahead Log (WAL) Configuration
# =============================================================================
[wal]
enabled = true

# WAL directory relative to data_dir (recommended)
dir = "wal"

# Maximum WAL segment size in MB
max_segment_mb = 64

# Checkpoint interval in milliseconds
checkpoint_interval_ms = 60000

# Synchronous commit mode: "off", "local", "remote_write", "remote_apply"
sync_mode = "local"

# Archive WAL segments for point-in-time recovery
archive_enabled = false
# archive_command = ""

# =============================================================================
# Cache Configuration
# =============================================================================
[cache]
# Cache is disposable by contract - can be cleared without data loss
enabled = true

# Maximum cache size in MB
max_size_mb = 512

# Enable ML model caching
ml_enabled = true

# Enable query result caching
query_cache_enabled = true

# Query cache TTL in milliseconds
query_cache_ttl_ms = 60000

# Maximum entries in query cache
query_cache_max_entries = 10000

# =============================================================================
# Metrics Configuration
# =============================================================================
[metrics]
enabled = true

# Metrics exposure mode:
#   "pull" - Prometheus-like scrape endpoint
#   "push" - Push to metrics collector
mode = "pull"

# Metrics endpoint bind address
listen_host = "127.0.0.1"
listen_port = 9100

# Metrics path (for pull mode)
path = "/metrics"

# Push interval in milliseconds (for push mode)
# push_interval_ms = 10000
# push_endpoint = ""

# =============================================================================
# Diagnostics Configuration
# =============================================================================
[diagnostics]
# Write build information to diag directory on startup
write_build_info = true

# Write runtime information periodically
write_runtime_info = true

# Maximum log content captured in diagnostic bundles (bytes)
max_log_bytes = 10485760

# Enable core dump generation on crash
core_dumps_enabled = false

# Diagnostic bundle compression
bundle_compression = "gzip"

# =============================================================================
# Compatibility Configuration
# =============================================================================
[compat]
# Strictness controls for version compatibility

# Fail if instance layout version is not supported
fail_on_unsupported_layout = true

# Fail if data format version is not supported
fail_on_unsupported_data_format = true

# Allow read-only mode for older but readable data formats
# allow_read_only_on_older_formats = true

# =============================================================================
# Advanced Configuration (Enterprise Features)
# =============================================================================

# Clustering configuration (optional)
# [clustering]
# enabled = false
# node_id = ""
# cluster_name = "rustydb-cluster"
# seeds = ["127.0.0.1:54320"]

# Replication configuration (optional)
# [replication]
# role = "primary"  # "primary", "replica", "standby"
# primary_host = ""
# primary_port = 54321

# Resource limits (optional)
# [resources]
# max_memory_mb = 0  # 0 = unlimited
# max_cpu_percent = 0  # 0 = unlimited
# max_io_bandwidth_mbps = 0  # 0 = unlimited
